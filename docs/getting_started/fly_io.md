# Deploy to Fly.io

[Fly.io](https://fly.io) is the go-to platform for deploying Phoenix apps.
This guide will help you deploy Jellyfish server on Fly.io.

First, we recommend you read the [Fly.io speedrun](https://fly.io/docs/speedrun/) for deploying an app.


Fly.io uses `fly.toml` files for configuring an app.
You can create a `fly.toml` file for your app by copying the [`fly.toml.sample`](https://github.com/jellyfish-dev/jellyfish/blob/main/fly.toml.sample).

## Creating new app

Launch `fly launch`. When prompted, copy the configuration from the existing `fly.toml` file.

Select appropriate app name and region, don't create any databases.
Don't deploy the app just yet.

Running `fly launch` may modify the `Dockerfile`.
Make sure to remove the lines appended by flyctl.

## Configuring the App

Before deploying your app, make sure it is correctly configured.

### Dedicated IPv4
In order to transmit multimedia via UDP, the app has to be publicly available with an IPv4 address.
By default Fly.io uses shared IP. To enable dedicated IPv4 address run 

```
fly ips allocate-v4
```
You can learn more about dedicated IPv4 address [here](https://fly.io/docs/reference/services/#dedicated-ipv4).

### fly.toml

Make sure you don't have the following lines in the `fly.toml`, which are automatically generated by `fly launch`.

You don't need to run migrations, since you don't have a database.
```
[deploy]
  release_command = "/app/bin/migrate"
```

Jellyfish uses `VIRTUAL_HOST` variable instead of the default `PHX_HOST`.
```
VIRTUAL_HOST = "<YOUR APP HOSTNAME>"
```  

Also, make sure you have set the correct port.
The enviroment variable `PORT` has to match the tcp `internal_port` defined under `services` section.
The default for Jellyfish is 4000.


To be able to receive and send UDP traffic, Jellyfish has to open its UDP ports on a special `fly-global-services` address, not `0.0.0.0`.

This must be set using the `INTEGRATED_TURN_PROD_ADDR` enviroment variable.
You also need to specify the Jellyfish IP address for UDP, it is the IP address which you generated in the previous step.
```
INTEGRATED_TURN_PROD_ADDR = "fly-global-services"
INTEGRATED_TURN_IP="<YOUR APP IP ADDRESS>"
```

You can also read [tutorial for running Fly.io apps which use UDP](https://fly.io/docs/app-guides/udp-and-tcp/).


### Fly.io secrets

There are enviroment variables, which you may not want to keep in the `fly.toml` config.
Fly.io provides a way to store such values securely.

For Jellyfish you need to configure `SECRET_KEY_BASE` and `TOKEN` secrets.
```
flyctl secrets set SECRET_KEY_BASE=super-secret-key
flyctl secrets set TOKEN=development
```

## Deploying

With everything configured you can deploy the app 
```
fly deploy
```
